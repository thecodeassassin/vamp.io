<!DOCTYPE html>




 <html class="no-js"> 
<head>

<script type="text/javascript">
theBaseUrl = "http://vamp.io/";
</script>
<base href="http://vamp.io/" />

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
  <title>Routing and load balancing - Vamp</title>
  <meta name="generator" content="Hugo 0.18-DEV" />

  
  <meta name="description" content="Vamp - Deploy and manage microservices with power and ease.">
  
  <link rel="canonical" href="./documentation/how-vamp-works/routing-and-load-balancing/">
  
  <meta name="author" content="magnetic.io">
  

  <meta property="og:url" content="/documentation/how-vamp-works/routing-and-load-balancing/">
  <meta property="og:title" content="Vamp">
  <meta property="og:image" content="/images/logo.svg">
  <meta name="apple-mobile-web-app-title" content="Vamp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="shortcut icon" type="image/x-icon" href="./images/logo.svg">
  <link rel="icon" type="image/x-icon" href="./images/logo.svg">


  <style>
    @font-face {
      font-family: 'Icon';
      src: url('fonts/icon.eot?52m981');
      src: url('fonts/icon.eot?#iefix52m981')
      format('embedded-opentype'),
      url('fonts/icon.woff?52m981')
      format('woff'),
      url('fonts/icon.ttf?52m981')
      format('truetype'),
      url('fonts/icon.svg?52m981#icon')
      format('svg');
      font-weight: normal;
      font-style: normal;
    }
  </style>

  <link rel="stylesheet" href="css/style.css">

  <script src="js/vendor.js"></script>

  <script src="js/app.js"></script>

  
</head>
<body class="palette-primary-pink palette-accent-pink">


<div class="single-page">
  <nav aria-label="Header" id="header" class="top-menu">
  <div class="left">
    <a href="./">
      <div id="logo" class="logo"></div>
    </a>
  </div>

  <div class="right">
    <div class="top-menu-items" id="top-menu-items">

    </div>

    <div class="download">
      <a href="./documentation/installation/hello-world/" class="button button--red">
        Try Vamp
      </a>
    </div>

    <a href="https://github.com/magneticio/vamp" target="_blank" class="github-logo">
      <i class="fa fa-2x fa-github" aria-hidden="true"></i>
    </a>

    <div class="search-button">
      <i class="fa fa-lg fa-search"></i>
    </div>

  </div>
</nav>

<ul id="mobile-menu" style="display: none">
</ul>

<div id="search">
  <div class="search-bar">
    <div class="search-bar__back">
      <i class="fa fa-lg fa-times"></i>
    </div>
    <input class="search-bar__input" placeholder="Type your search here...">
  </div>
  <div class="search-results">
    <ul></ul>
  </div>
</div>


</div>

<div class="page documentation">
    <div class="menu" id="side-menu">
    </div>
    <div class="content">
      <h1 class="content-header">Routing and load balancing </h1>
      <div class="markdowned">
        

<p>Vamp uses the tried and tested HAProxy reverse proxy software for routing/proxying and load balancing (<a href="https://www.haproxy.com">haproxy.com</a>). Vamp Gateway Agent (VGA) manages the HAProxy configuration and HAProxy routes incoming traffic to endpoints (explicitly defined external gateways) or handles intra-service routing. By applying some iptables magic, Vamp makes sure that HAProxy configuration updates won&rsquo;t introduce dropped packages., that means zero-downtime reloads.</p>

<h2 id="routing">Routing</h2>

<p>So how does Vamp exactly route traffic to the designated destinations? First we look for the <a href="./documentation/using-vamp/conditions/">conditions</a> that might have been set for a route or gateway. This can be none, one or more conditions (see <a href="./documentation/using-vamp/conditions/#boolean-expression-in-conditions">boolean expression in conditions</a>). There are built-in short codes for common conditions, or you can use HAProxy ACLs directly.</p>

<p>If the condition is met, we evaluate the condition strength percentage. A 100% setting means everybody that meets the condition is sent to this route. A 5% setting means 5% of all visitors that meet the condition are sent to this route, the remaining 95% are returned into the &ldquo;bucket&rdquo; and distributed using the general weight settings. A weight setting for each available route defines the distribution of all remaining traffic not matching a condition or not targetted by condition strength.</p>

<h2 id="load-balancing">Load balancing</h2>

<p>Vamp load balancing is done transparently. Based on the scale setting of the running services, Vamp will make sure all instances are load balanced automatically. By default we use a round-robin algorithm, but other HAProxy balancing mechanisms are also supported. We also support sticky routing. The cool thing is that weight and condition percentage settings are applied independently from the number of instances running. I.e. a 50 / 50 weight distribution over two service versions that run with a scale of four and eight instances respectively will still be distributed 50% / 50%. Changing the number of instances will have no effect on the distribution, as Vamp tries to achieve the configured weight and condition strength distributions as closely as possible.</p>

<h2 id="topology-and-performance">Topology and performance</h2>

<p>HAProxy can run as a container or as a standalone service. A Vamp Gateway Agent (VGA) Docker image (including HAProxy with specific logstash configuration to provide proxy logs to logstash for the Vamp UI) can be pulled from the Docker hub (<a href="https://hub.docker.com/r/magneticio/vamp-gateway-agent/">hub.docker.com - magneticio Vamp Gateway Agent</a>).</p>

<p>HAProxy can run inside your cluster or on separate machines outside of your container cluster:</p>

<ul>
<li>HAProxy on one node of a cluster - not advised for production setups as it introduces a single point of failure</li>
<li>HAProxy on multiple nodes of a cluster - for example, three instances for failover and high-availability</li>
<li>HAProxy on all nodes of a cluster - the so-called SmartStack pattern (<a href="http://nerds.airbnb.com/smartstack-service-discovery-cloud/">nerds.airbnb.com - smartstack service discovery cloud</a>)</li>
<li>HAProxy on separate machines outside of your container cluster - Vamp can connect to these instances and can add its routing rules to your custom HAProxy configuration templates if needed.</li>
</ul>

<p>Performance-wise, HAProxy is very efficient and uses few resources. In our experiments we have seen a sub-millisecond overhead. Even with very complex and combined routing rules, the total overhead stays in the microseconds range. This means a single HAProxy running on a small VM (for example, an AWS micro instance) would process enough network traffic that you would notice a bottleneck from your network and applications first.</p>

<p>Vamp is not a realtime system. As long as at least one HAProxy and one container-node are running your visitors will be able to reach the container - even with no Vamp or VGA running. On restart, Vamp and VGA will automatically sync and update themselves.</p>

<div class="admonition note">
  <p class="admonition-title">What next?</p>
  <p><ul>
<li>Read about how Vamp works with <a href="./documentation/how-vamp-works/events-and-metrics">events and metrics</a></li>
<li>Find out more about using Vamp <a href="./documentation/using-vamp/conditions">conditions</a> and <a href="./documentation/using-vamp/gateways">gateways</a></li>
</ul>
</p>
</div>

      </div>
    </div>
</div>

<div class="lander-row lander-row--blue footer">
  <div class="container">
    <div class="row">
      <div class="col col-3">
        <h2 class="h2">Learn more</h2>
        <a href="./why-use-vamp/">
          <p class="text">Why use Vamp?</p>
        </a>
        <a href="./documentation/how-vamp-works/architecture-and-components">
          <p class="text">Documentation</p>
        </a>
        <a href="./about/">
          <p class="text">About us</p>
        </a>
        <a href="./resources/news/">
          <p class="text">News</p>
        </a>
        <a href="./contact/">
          <p class="text">Contact</p>
        </a>
      </div>
        <div class="col col-6">
        <h2 class="h2">All things code</h2>
          <a href="./support/">
            <p class="text">Support</p>
          </a>
          <a href="./resources/community/">
            <p class="text">Community</p>
          </a>
          <a href="https://github.com/magneticio/vamp" target="_blank">
            <p class="text">GitHub</p>
          </a>
          <a href="https://gitter.im/magneticio/vamp" target="_blank">
            <p class="text">Gitter</p>
          </a>
      </div>
      <div class="col col-6">
        <h2 class="h2">Stay up to date</h2>
        <p class="text">
          Leave your email for the latest news: We won’t spam you and won’t go off topic.
        </p>

        <form action="//magnetic.us9.list-manage.com/subscribe/post?u=c709b3ab8cce9e00d617e01b6&amp;id=c1465e21d0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate form-inline" style="display: inline" target="_blank" novalidate="">
          <div class="input-group">
            <input type="email" name="EMAIL" id="mce-EMAIL" placeholder="Email">
            <a onclick="$(this).closest('form').submit()" class="button button--red not-active">
              <div class="button__icon button__icon--mail">
              </div>
            </a>
          </div>
        </form>

        
          
        


        <div class="social-buttons">
          <p class="text">Follow us on: </p>
          <a href="https://twitter.com/vamp_io" target="_blank">
            <i class="fa fa-2x fa-twitter"></i>
          </a>

          <a href="https://www.linkedin.com/company/magnetic-io" target="_blank">
            <i class="fa fa-2x fa-linkedin"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="footer-bottom lander-row--blue">
  <div class="container">
    <div class="part">
      <a href="./about/"><img class="magnetic-logo" src="./img/005-vamp/Logo/magnetic-logo-footer.svg" alt=""></a>
    </div>
    <div class="part">
      <img class="vamp-bat" src="./img/003-Small-icons/Medium-blue/VAMP-Medium.svg" alt="">
      <p class="text">Code licensed under <a type="application/rss+xml" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2</a> © 2016 <a href="./about/">Magnetic.io</a></p>
    </div>
  </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59948816-1', 'auto');
  ga('send', 'pageview');

</script>

