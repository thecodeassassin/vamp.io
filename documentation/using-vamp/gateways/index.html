<!DOCTYPE html>




 <html class="no-js"> 
<head>

<script type="text/javascript">
theBaseUrl = "http://vamp.io/";
</script>
<base href="http://vamp.io/" />

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
  <title>Gateways - Vamp</title>
  <meta name="generator" content="Hugo 0.18-DEV" />

  
  <meta name="description" content="Vamp - Deploy and manage microservices with power and ease.">
  
  <link rel="canonical" href="./documentation/using-vamp/gateways/">
  
  <meta name="author" content="magnetic.io">
  

  <meta property="og:url" content="/documentation/using-vamp/gateways/">
  <meta property="og:title" content="Vamp">
  <meta property="og:image" content="/images/logo.svg">
  <meta name="apple-mobile-web-app-title" content="Vamp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="shortcut icon" type="image/x-icon" href="./images/logo.svg">
  <link rel="icon" type="image/x-icon" href="./images/logo.svg">


  <style>
    @font-face {
      font-family: 'Icon';
      src: url('fonts/icon.eot?52m981');
      src: url('fonts/icon.eot?#iefix52m981')
      format('embedded-opentype'),
      url('fonts/icon.woff?52m981')
      format('woff'),
      url('fonts/icon.ttf?52m981')
      format('truetype'),
      url('fonts/icon.svg?52m981#icon')
      format('svg');
      font-weight: normal;
      font-style: normal;
    }
  </style>

  <link rel="stylesheet" href="css/style.css">

  <script src="js/vendor.js"></script>

  <script src="js/app.js"></script>

  
</head>
<body class="palette-primary-pink palette-accent-pink">


<div class="single-page">
  <nav aria-label="Header" id="header" class="top-menu">
  <div class="left">
    <a href="./">
      <div id="logo" class="logo"></div>
    </a>
  </div>

  <div class="right">
    <div class="top-menu-items" id="top-menu-items">

    </div>

    <div class="download">
      <a href="./documentation/installation/hello-world/" class="button button--red">
        Try Vamp
      </a>
    </div>

    <a href="https://github.com/magneticio/vamp" target="_blank" class="github-logo">
      <i class="fa fa-2x fa-github" aria-hidden="true"></i>
    </a>

    <div class="search-button">
      <i class="fa fa-lg fa-search"></i>
    </div>

  </div>
</nav>

<ul id="mobile-menu" style="display: none">
</ul>

<div id="search">
  <div class="search-bar">
    <div class="search-bar__back">
      <i class="fa fa-lg fa-times"></i>
    </div>
    <input class="search-bar__input" placeholder="Type your search here...">
  </div>
  <div class="search-results">
    <ul></ul>
  </div>
</div>


</div>

<div class="page documentation">
    <div class="menu" id="side-menu">
    </div>
    <div class="content">
      <h1 class="content-header">Gateways </h1>
      <div class="markdowned">
        

<p>Gateways are dynmic runtime entities in the Vamp eco-system. They represent load balancer rules to deployment, cluster and service instances. There are two types of gateways:</p>

<ul>
<li><strong>Internal gateways</strong> are created automatically for each deployment cluster and updated using the gateway/deployment API</li>
<li><strong>External gateways</strong> are explicitly declared either in a deployment blueprint or using the gateway API</li>
</ul>

<h4 id="example-automatically-created-gateway">Example - automatically created gateway</h4>

<p>The below gateway is for deployment <code>vamp</code>, cluster <code>sava</code> and port <code>port</code>.<br />
The cluster contains two services <code>sava:1.0.0</code> and <code>sava:1.1.0</code>, each with two running instances.</p>

<pre><code class="language-yaml">---
name: vamp/sava/port           # name
port: 40000/http               # port, either http or tcp, assigned by Vamp
active: true                   # is it running - not in case of non (yet) existing routes
sticky: none
routes:                        # routes
  vamp/sava/sava:1.0.0/port:
    weight: 50%
    instances:
    - name: vamp_6fd83b1fd01f7dd9eb7f.cda3c376-ae26-11e5-91fb-0242f7e42bf3
      host: default
      port: 31463
    - name: vamp_6fd83b1fd01f7dd9eb7f.cda2d915-ae26-11e5-91fb-0242f7e42bf3
      host: default
      port: 31292
  vamp/sava/sava:1.1.0/port:
    weight: 50%
    instances:
    - name: vamp_2e2fc6ab8a1cdbe79dc3.caa3c9e4-ae26-11e5-91fb-0242f7e42bf3
      host: default
      port: 31634
    - name: vamp_2e2fc6ab8a1cdbe79dc3.caa37bc3-ae26-11e5-91fb-0242f7e42bf3
      host: default
      port: 31826
</code></pre>

<h2 id="gateway-usage">Gateway Usage</h2>

<p>The gateway API allows for programmable routing. External gateways give an entry point to clusters (optionally specified in deployment blueprints), and allow for canary releasing and A/B testing across deployments.</p>

<p>A gateway defines a set of rules for routing traffic between different services within the same cluster.
Vamp allows you to determine this in three ways:</p>

<ul>
<li>A <code>condition</code> will target specific traffic. Read more about <a href="./documentation/using-vamp/conditions">conditions</a><br />
<em>for example, IOS users</em></li>
<li>The <code>condition_strength</code> targets a percentage of traffic matching a condition<br />
<em>for example, 10% of IOS users</em></li>
<li>The <code>weight</code> for each available route (%) defines the distribution of all remaining traffic (not matching or not targetted by a condition)<br />
<em>for example, 100% of all traffic, except the targetted 10% of IOS users</em></li>
</ul>

<h3 id="routes-condition-strength-and-weights">Routes, condition-strength and weights</h3>

<p>Each route can have a weight and one or more conditions (see <a href="./documentation/using-vamp/conditions/#boolean-expression-in-conditions">boolean expression in conditions</a>). Each condition has a condition-strength.</p>

<p>Routing is calculated as followed:</p>

<ol>
<li>Find the first <code>condition</code> that matches the request. Read more about <a href="./documentation/using-vamp/conditions">conditions</a><br />
<em>for example, IOS users</em></li>
<li>If the route exists, send the request to it depending on the <code>condition strength</code><br />
<em>for example, 10% of IOS users are sent to the route</em></li>
<li>If, based on <code>condition strength</code>, the request <strong>should not</strong> follow that route, then send request to one from all routes based on their <code>weight</code>.<br />
<em>for example, all non-IOS traffic and 90% of IOS users are routed according to route weight</em></li>
</ol>

<div class="admonition note">
  <p class="admonition-title">Note!</p>
  <p>Vamp has to account for all traffic.<br />
When defining weights, the total weight of all routes must always add up to 100%.
This means that in a straight three-way split one service must be given 34% as <code>33%+33%+33%=99%</code>.  1% can be a lot of traffic in high volume environments.</p>
</div>

<h4 id="example-route-all-firefox-and-only-firefox-users-to-route-service-b">Example - Route all <code>Firefox</code> and only <code>Firefox</code> users to route <code>service_B</code>:</h4>

<pre><code class="language-yaml">service_A:
  weight: 100%
service_B:
  weight: 0%
  condition_strength: 100%
  condition: user-agent == Firefox
</code></pre>

<h4 id="example-route-half-of-firefox-users-to-service-b-other-half-to-service-a-80-or-service-b-20">Example - Route half of <code>Firefox</code> users to <code>service_B</code>, other half to <code>service_A</code> (80%) or <code>service_B</code> (20%):</h4>

<p>Non <code>Firefox</code> requests will be just sent to <code>service_A</code> (80%) or <code>service_B</code> (20%).</p>

<pre><code class="language-yaml">service_A:
  weight: 80%
service_B:
  weight: 20%
  condition_strength: 50%
  condition: user-agent == Firefox
</code></pre>

<h4 id="example-a-b-test-two-deployments-using-route-weight">Example - A/B test two deployments using route weight</h4>

<p>Below is a basic example, similar to putting both deployments (<code>sava:1.0.0</code> and <code>sava:1.1.0</code>) in the same cluster.<br />
It is easy to imagine having an older legacy application and the new one and doing a full canary release (or A/B testing) in seamless way by using gateways like this.</p>

<p>Deployment 1: <code>PUT /api/v1/deployments/sava:1.0</code></p>

<pre><code class="language-yaml">---
name: sava:1.0
gateways:
  9050/http: sava/port
clusters:
  sava:
    services:
      -
        breed:
          name: sava:1.0.0
          deployable: magneticio/sava:1.0.0
          ports:
            port: 8080/http
            
        scale:
          cpu: 0.2
          memory: 256MB
          instances: 2
</code></pre>

<p>Deployment 2: <code>PUT /api/v1/deployments/sava:1.1</code></p>

<pre><code class="language-yaml">---
name: sava:1.1
gateways:
  9060/http: sava/port
clusters:
  sava:
    services:
      -
        breed:
          name: sava:1.1.0
          deployable: magneticio/sava:1.1.0
          ports:
            port: 8080/http
            
        scale:
          cpu: 0.2
          memory: 256MB
          instances: 2
</code></pre>

<p>Gateway (90% / 10%): <code>POST /api/v1/gateways</code></p>

<pre><code class="language-yaml">---
name: sava
port: 9070/http
routes:
  sava:1.0/sava/port:
    weight: 90%          # condition can be used as well
  sava:1.1/sava/port:
    weight: 10%
</code></pre>

<h2 id="url-path-rewrite">URL path rewrite</h2>

<p>Vamp supports URL path rewrite. This can be a powerful solution in defining service APIs (e.g. RESTful) outside of application service.  Path rewrite is defined in the format <code>path: NEW_PATH if CONDITION</code>, where:</p>

<ul>
<li><code>NEW_PATH</code> new path to be used; HAProxy variables are supported, e.g. <code>%[path]</code></li>
<li><code>CONDITION</code> condition using HAProxy directives, e.g. matching path, method, headers etc.</li>
</ul>

<h4 id="example">Example</h4>

<pre><code class="language-yaml">routes:
  web/port1:
    rewrites:
    - path: a if b
  web/port2:
    weight: 100%
</code></pre>

<h2 id="vamp-managed-and-external-routes">Vamp managed and external routes</h2>

<p>Vamp managed routes are in the format:</p>

<ul>
<li><code>gateway</code> - pointing to another gateway, e.g. it is possible to chain gateways</li>
<li><code>deployment/cluster</code> - pointing to deployment cluster, i.e. services are not &lsquo;visible&rsquo;</li>
<li><code>deployment/cluster/service</code> - pointing to specific service within deployment cluster</li>
</ul>

<p>All examples above cover only Vamp managed routes.
It is also possible to route traffic to specific IP or hostname and port.
In that case IP or hostname and port need to be specified between brackets, e.g. <code>[hostname:port]</code> (and double quotes due to Yaml syntax).</p>

<pre><code class="language-yaml">name: mesos
port: 8080/http
sticky: route

routes:
  &quot;[192.168.99.100:5050]&quot;:
    weight: 50%
  &quot;[localhost:5050]&quot;:
    weight: 50%
</code></pre>

<div class="admonition note">
  <p class="admonition-title">What next?</p>
  <p><ul>
<li>Read about <a href="./documentation/using-vamp/conditions/">Vamp conditions</a></li>
<li>Check the <a href="./documentation/api/api-reference">API documentation</a></li>
<li><a href="./documentation/installation/hello-world">Try Vamp</a></li>
</ul>
</p>
</div>

      </div>
    </div>
</div>

<div class="lander-row lander-row--blue footer">
  <div class="container">
    <div class="row">
      <div class="col col-3">
        <h2 class="h2">Learn more</h2>
        <a href="./why-use-vamp/">
          <p class="text">Why use Vamp?</p>
        </a>
        <a href="./documentation/how-vamp-works/architecture-and-components">
          <p class="text">Documentation</p>
        </a>
        <a href="./about/">
          <p class="text">About us</p>
        </a>
        <a href="./resources/news/">
          <p class="text">News</p>
        </a>
        <a href="./contact/">
          <p class="text">Contact</p>
        </a>
      </div>
        <div class="col col-6">
        <h2 class="h2">All things code</h2>
          <a href="./support/">
            <p class="text">Support</p>
          </a>
          <a href="./resources/community/">
            <p class="text">Community</p>
          </a>
          <a href="https://github.com/magneticio/vamp" target="_blank">
            <p class="text">GitHub</p>
          </a>
          <a href="https://gitter.im/magneticio/vamp" target="_blank">
            <p class="text">Gitter</p>
          </a>
      </div>
      <div class="col col-6">
        <h2 class="h2">Stay up to date</h2>
        <p class="text">
          Leave your email for the latest news: We won’t spam you and won’t go off topic.
        </p>

        <form action="//magnetic.us9.list-manage.com/subscribe/post?u=c709b3ab8cce9e00d617e01b6&amp;id=c1465e21d0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate form-inline" style="display: inline" target="_blank" novalidate="">
          <div class="input-group">
            <input type="email" name="EMAIL" id="mce-EMAIL" placeholder="Email">
            <a onclick="$(this).closest('form').submit()" class="button button--red not-active">
              <div class="button__icon button__icon--mail">
              </div>
            </a>
          </div>
        </form>

        
          
        


        <div class="social-buttons">
          <p class="text">Follow us on: </p>
          <a href="https://twitter.com/vamp_io" target="_blank">
            <i class="fa fa-2x fa-twitter"></i>
          </a>

          <a href="https://www.linkedin.com/company/magnetic-io" target="_blank">
            <i class="fa fa-2x fa-linkedin"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="footer-bottom lander-row--blue">
  <div class="container">
    <div class="part">
      <a href="./about/"><img class="magnetic-logo" src="./img/005-vamp/Logo/magnetic-logo-footer.svg" alt=""></a>
    </div>
    <div class="part">
      <img class="vamp-bat" src="./img/003-Small-icons/Medium-blue/VAMP-Medium.svg" alt="">
      <p class="text">Code licensed under <a type="application/rss+xml" href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2</a> © 2016 <a href="./about/">Magnetic.io</a></p>
    </div>
  </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59948816-1', 'auto');
  ga('send', 'pageview');

</script>

